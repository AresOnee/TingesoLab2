version: '3.8'

services:
  # ==================== BASES DE DATOS ====================

  mysql-tools:
    image: mysql:8.0
    container_name: mysql-tools
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: tools_db
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "3307:3306"
    volumes:
      - mysql-tools-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-prootpass"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s
    networks:
      - toolrent-network

  mysql-clients:
    image: mysql:8.0
    container_name: mysql-clients
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: clients_db
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "3308:3306"
    volumes:
      - mysql-clients-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-prootpass"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s
    networks:
      - toolrent-network

  mysql-config:
    image: mysql:8.0
    container_name: mysql-config
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: config_db
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "3309:3306"
    volumes:
      - mysql-config-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-prootpass"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s
    networks:
      - toolrent-network

  mysql-loans:
    image: mysql:8.0
    container_name: mysql-loans
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: loans_db
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "3310:3306"
    volumes:
      - mysql-loans-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-prootpass"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s
    networks:
      - toolrent-network

  mysql-kardex:
    image: mysql:8.0
    container_name: mysql-kardex
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: kardex_db
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "3311:3306"
    volumes:
      - mysql-kardex-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-prootpass"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s
    networks:
      - toolrent-network

  mysql-users:
    image: mysql:8.0
    container_name: mysql-users
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: users_db
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "3312:3306"
    volumes:
      - mysql-users-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-prootpass"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s
    networks:
      - toolrent-network

  # ==================== INFRAESTRUCTURA ====================
  
  config-server:
    build: ./config-server
    container_name: config-server
    ports:
      - "8888:8888"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8888/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - toolrent-network

  eureka-server:
    build: ./eureka-server
    container_name: eureka-server
    ports:
      - "8761:8761"
    depends_on:
      config-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8761/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - toolrent-network

  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    ports:
      - "8080:8080"
    depends_on:
      eureka-server:
        condition: service_healthy
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    networks:
      - toolrent-network

  # ==================== MICROSERVICIOS ====================

  ms-tools:
    build: ./ms-tools
    container_name: ms-tools
    restart: on-failure
    depends_on:
      eureka-server:
        condition: service_healthy
      mysql-tools:
        condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-tools:3306/tools_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true&characterEncoding=UTF-8
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=rootpass
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    networks:
      - toolrent-network

  ms-clients:
    build: ./ms-clients
    container_name: ms-clients
    restart: on-failure
    depends_on:
      eureka-server:
        condition: service_healthy
      mysql-clients:
        condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-clients:3306/clients_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true&characterEncoding=UTF-8
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=rootpass
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    networks:
      - toolrent-network

  ms-config:
    build: ./ms-config
    container_name: ms-config
    restart: on-failure
    depends_on:
      eureka-server:
        condition: service_healthy
      mysql-config:
        condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-config:3306/config_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true&characterEncoding=UTF-8
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=rootpass
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    networks:
      - toolrent-network

  ms-kardex:
    build: ./ms-kardex
    container_name: ms-kardex
    restart: on-failure
    depends_on:
      eureka-server:
        condition: service_healthy
      mysql-kardex:
        condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-kardex:3306/kardex_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true&characterEncoding=UTF-8
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=rootpass
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    networks:
      - toolrent-network

  ms-loans:
    build: ./ms-loans
    container_name: ms-loans
    restart: on-failure
    depends_on:
      eureka-server:
        condition: service_healthy
      mysql-loans:
        condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-loans:3306/loans_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true&characterEncoding=UTF-8
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=rootpass
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    networks:
      - toolrent-network

  ms-reports:
    build: ./ms-reports
    container_name: ms-reports
    restart: on-failure
    depends_on:
      eureka-server:
        condition: service_healthy
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    networks:
      - toolrent-network

  ms-users:
    build: ./ms-users
    container_name: ms-users
    restart: on-failure
    depends_on:
      eureka-server:
        condition: service_healthy
      mysql-users:
        condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-users:3306/users_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true&characterEncoding=UTF-8
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=rootpass
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    networks:
      - toolrent-network

networks:
  toolrent-network:
    driver: bridge

volumes:
  mysql-tools-data:
  mysql-clients-data:
  mysql-config-data:
  mysql-loans-data:
  mysql-kardex-data:
  mysql-users-data:
