# ============================================
# API GATEWAY CONFIG FOR KUBERNETES
# Usa Eureka Service Discovery con lb://
# ============================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: api-gateway-config
  namespace: toolrent
  labels:
    app: api-gateway
data:
  application.yml: |
    server:
      port: 8080

    spring:
      application:
        name: api-gateway
      cloud:
        gateway:
          routes:
            # MS-TOOLS (Épica 1: Gestión de Herramientas)
            - id: ms-tools
              uri: lb://MS-TOOLS
              predicates:
                - Path=/api/v1/tools,/api/v1/tools/**
            # MS-LOANS (Épica 2: Préstamos y Devoluciones)
            - id: ms-loans
              uri: lb://MS-LOANS
              predicates:
                - Path=/api/v1/loans,/api/v1/loans/**
            # MS-CLIENTS (Épica 3: Gestión de Clientes)
            - id: ms-clients
              uri: lb://MS-CLIENTS
              predicates:
                - Path=/api/v1/clients,/api/v1/clients/**
            # MS-CONFIG (Épica 4: Gestión de Tarifas)
            - id: ms-config
              uri: lb://MS-CONFIG
              predicates:
                - Path=/api/v1/config,/api/v1/config/**
            # MS-KARDEX (Épica 5: Kardex y Movimientos)
            - id: ms-kardex
              uri: lb://MS-KARDEX
              predicates:
                - Path=/api/v1/kardex,/api/v1/kardex/**
            # MS-REPORTS (Épica 6: Reportes y Consultas)
            - id: ms-reports
              uri: lb://MS-REPORTS
              predicates:
                - Path=/api/v1/reports,/api/v1/reports/**
          globalcors:
            corsConfigurations:
              '[/**]':
                allowedOriginPatterns:
                  - "http://localhost:*"
                  - "http://127.0.0.1:*"
                  - "http://172.*:*"
                  - "http://192.168.*:*"
                  - "http://10.*:*"
                  - "http://frontend:*"
                allowedMethods:
                  - GET
                  - POST
                  - PUT
                  - DELETE
                  - OPTIONS
                  - PATCH
                allowedHeaders: "*"
                allowCredentials: true
                maxAge: 3600

    # Habilitar Eureka Service Discovery
    eureka:
      client:
        enabled: true
        service-url:
          defaultZone: http://eureka-server:8761/eureka/
      instance:
        prefer-ip-address: true

    # OAuth2 Resource Server (Keycloak)
    spring.security.oauth2.resourceserver.jwt.jwk-set-uri: http://keycloak:8080/realms/sisgr-realm/protocol/openid-connect/certs

    # Actuator
    management:
      endpoints:
        web:
          exposure:
            include: health,info,gateway
      endpoint:
        health:
          show-details: always
